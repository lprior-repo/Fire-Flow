---
# TCR Enforcer CLI Tool + Kestra Orchestration
# Epic definition with all features and tasks

epic:
  id: tcr-enforcer-cli
  title: "TCR Enforcer CLI Tool + Kestra Orchestration"
  description: |
    Standalone Go CLI tool that enforces Test-Driven Development and Test && Commit || Revert workflows.
    Kestra orchestrates the tool execution.

  features:
    # PHASE 1: STATE & CONFIG
    - id: feature-state-config
      title: "CLI State & Config Foundation"
      description: "Persistent state management and YAML configuration"
      blocks:
        - feature-tdd-gate
        - feature-test-execution
        - feature-git-ops
      tasks:
        - id: task-state-struct
          title: "Design state struct and persistence (JSON)"
          description: |
            Define EnforcerState struct with:
            - Mode (string)
            - FailingTests ([]string)
            - RevertStreak (int)
            - LastCommitTime (time.Time)

            Acceptance Criteria:
            - State persists to .opencode/tcr/state.json
            - State is readable/writable under concurrent access
            - State survives process restart

        - id: task-init-command
          title: "Implement tcr-enforcer init command"
          description: |
            Create init subcommand that:
            - Creates .opencode/tcr/ directory
            - Initializes state.json with defaults
            - Loads or creates config.yml

            Acceptance Criteria:
            - `tcr-enforcer init` exits 0 on success
            - Creates state.json with RevertStreak=0, FailingTests=[]
            - Loads config.yml if exists, uses defaults otherwise

        - id: task-yaml-config
          title: "Implement YAML config loader"
          description: |
            Load config.yml from .opencode/tcr/ with fields:
            - testCommand (string): "go test -json ./..."
            - testPatterns ([]string): ["_test\\.go$"]
            - protectedPaths ([]string): ["opencode.json", ".opencode/tcr"]
            - timeout (int): 30 (seconds)

            Acceptance Criteria:
            - Config loads on startup
            - Environment variables override YAML values
            - Defaults applied for missing values

        - id: task-status-command
          title: "Implement tcr-enforcer status command"
          description: |
            Command outputs current state in human-readable format:
            ```
            State: GREEN
            RevertStreak: 0
            LastCommit: 2024-12-22T15:30:00Z
            FailingTests: []
            ```

            Acceptance Criteria:
            - `tcr-enforcer status` reads state.json
            - Exits 0 always
            - Output is parseable (JSON with --json flag)

    # PHASE 2: CORE ENFORCEMENT
    - id: feature-tdd-gate
      title: "TDD Gate CLI Command"
      description: "Enforce TDD: block implementation writes when tests pass"
      depends_on:
        - feature-state-config
      blocks:
        - feature-kestra-flow
      tasks:
        - id: task-pattern-matcher
          title: "Implement test file pattern matcher (regex)"
          description: |
            Pre-compile regex patterns from config.testPatterns
            Function: IsTestFile(path string) bool

            Acceptance Criteria:
            - Matches "_test.go" files
            - Doesn't match "utils.go" files
            - Supports multiple patterns from config

        - id: task-test-state-detector
          title: "Implement test state detector (parse go test output)"
          description: |
            Run `go test -json ./...` and parse output
            Extract: failed test names, passed count, duration

            Acceptance Criteria:
            - Detects RED state (len(failedTests) > 0)
            - Detects GREEN state (len(failedTests) == 0)
            - Extracts specific test names

        - id: task-tdd-gate-command
          title: "Implement tdd-gate command with decision logic"
          description: |
            Command: `tcr-enforcer tdd-gate --file <path>`

            Logic:
            - If IsTestFile(path) → exit 0 "ALLOWED: Test file"
            - If GREEN && !IsTestFile(path) → exit 1 "BLOCKED: Write test first. State: GREEN"
            - If RED && !IsTestFile(path) → exit 0 "ALLOWED: Red state detected"

            Acceptance Criteria:
            - Exit code 0 = allowed, 1 = blocked
            - Clear error messages guide user
            - Protected paths always blocked

    - id: feature-test-execution
      title: "Test Execution CLI Command"
      description: "Execute tests with timeout and structured output"
      depends_on:
        - feature-state-config
      blocks:
        - feature-git-ops
      tasks:
        - id: task-run-tests-command
          title: "Implement run-tests command with timeout"
          description: |
            Command: `tcr-enforcer run-tests`

            - Reads testCommand from config
            - Executes in project root
            - Enforces timeout (default 30s)
            - Returns: exit code, test output, duration

            Acceptance Criteria:
            - Exit 0 if all tests pass
            - Exit non-zero if any test fails
            - Kills process if timeout exceeded
            - Returns test output in stdout

        - id: task-json-output
          title: "Implement structured JSON output"
          description: |
            Output format:
            ```json
            {
              "passed": true|false,
              "failedTests": ["test_name1", "test_name2"],
              "duration": 5,
              "output": "..."
            }
            ```

            Acceptance Criteria:
            - `tcr-enforcer run-tests --json` outputs valid JSON
            - Can be parsed by Kestra flows

    - id: feature-git-ops
      title: "Git Operations CLI Commands"
      description: "Commit and revert code via CLI"
      depends_on:
        - feature-state-config
      blocks:
        - feature-kestra-flow
      tasks:
        - id: task-commit-command
          title: "Implement commit command"
          description: |
            Command: `tcr-enforcer commit --message "WIP"`

            - git add .
            - git commit -m <message>
            - Update state.json: RevertStreak = 0, LastCommitTime = now

            Acceptance Criteria:
            - Exit 0 on success
            - Outputs commit hash
            - Updates state correctly

        - id: task-revert-command
          title: "Implement revert command"
          description: |
            Command: `tcr-enforcer revert`

            - git reset --hard HEAD
            - Update state.json: RevertStreak += 1
            - Destructive (cannot be undone)

            Acceptance Criteria:
            - Exit 0 after revert
            - All changes deleted from filesystem
            - State updated with new streak count

    # PHASE 3: KESTRA INTEGRATION
    - id: feature-kestra-flow
      title: "Kestra TCR Orchestration Flow"
      description: "Kestra flows that orchestrate CLI commands"
      depends_on:
        - feature-tdd-gate
        - feature-git-ops
      blocks:
        - feature-opencode-integration
      tasks:
        - id: task-create-kestra-flow
          title: "Create tcr-enforcement-workflow.yml in kestra/flows/"
          description: |
            Kestra flow that:
            1. Listens for file change events or manual trigger
            2. Reads changed file path
            3. Executes tcr-enforcer commands in sequence
            4. Outputs result.json

            Flow steps:
            - Call tcr-enforcer status
            - Call tcr-enforcer tdd-gate --file <file>
            - If gate passes: call tcr-enforcer run-tests
            - If tests pass: call tcr-enforcer commit
            - If tests fail: call tcr-enforcer revert

        - id: task-flow-branching
          title: "Implement flow decision branching"
          description: |
            Use Kestra conditions to:
            - Skip run-tests if tdd-gate blocks
            - Commit only if tests pass
            - Revert if tests fail

            Acceptance Criteria:
            - Flow can be manually triggered from UI
            - Flow can accept file path as input
            - Each step logs its output

        - id: task-result-formatting
          title: "Implement result formatting for OpenCode"
          description: |
            Flow outputs result.json:
            ```json
            {
              "action": "BLOCKED|ALLOWED|COMMITTED|REVERTED",
              "reason": "...",
              "streak": 0,
              "output": "..."
            }
            ```

            Acceptance Criteria:
            - Result can be returned to agent
            - Contains enough info for agent to adjust behavior

    # PHASE 4: OPENCODE INTEGRATION
    - id: feature-opencode-integration
      title: "OpenCode + Kestra Integration"
      description: "Connect OpenCode agent to Kestra flows"
      depends_on:
        - feature-kestra-flow
      tasks:
        - id: task-webhook-setup
          title: "Document Kestra webhook configuration"
          description: |
            Document how to:
            - Get Kestra API endpoint
            - Create API token
            - Call flow via webhook

            Example:
            POST /api/v1/flows/{namespace}/{id}/executions
            with inputs: {file: "pkg/auth/login.go"}

        - id: task-opencode-setup
          title: "Document OpenCode integration setup"
          description: |
            Document how to:
            - Configure opencode.json to call Kestra
            - Pass write events to Kestra
            - Parse result and return to agent
            - Update agent prompt for feedback loop

    # PHASE 5: TESTING & COMPLETION
    - id: feature-unit-tests
      title: "Unit Tests"
      description: "Go tests for CLI logic"
      tasks:
        - id: task-gate-tests
          title: "Test TDD gate logic"
          description: |
            Unit tests for:
            - Pattern matching (test vs impl files)
            - RED/GREEN detection
            - Blocking/allowing decisions

        - id: task-loop-tests
          title: "Test test execution and parsing"
          description: |
            Unit tests for:
            - Command execution
            - JSON parsing
            - Timeout handling

        - id: task-state-tests
          title: "Test state persistence and concurrency"
          description: |
            Unit tests for:
            - State read/write
            - RWMutex protection
            - State survival across restarts
