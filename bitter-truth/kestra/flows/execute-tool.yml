# Modular Component: Execute Generated Nushell Tool
#
# INPUT: tool_path, tool_input (JSON)
# OUTPUT: output_file (/tmp/output.json), logs_file (/tmp/logs.json)
# ERRORS: Graceful (exit 0, JSON error response)
#
# Pure function: nushell tool + json input -> execution result
# Handles stdin->stdout, captures output and logs

id: execute-tool
namespace: bitter
description: Execute generated Nushell tool with JSON input

inputs:
  - id: tool_path
    type: STRING
    description: Path to generated Nushell tool

  - id: tool_input
    type: STRING
    defaults: "{}"
    description: JSON input for the tool

  - id: output_path
    type: STRING
    defaults: "/tmp/output.json"
    description: Where to save tool output

  - id: logs_path
    type: STRING
    defaults: "/tmp/logs.json"
    description: Where to save tool logs

  - id: tools_dir
    type: STRING
    defaults: "./bitter-truth/tools"
    description: Directory containing bitter-truth tools

  - id: trace_id
    type: STRING
    defaults: ""
    description: Trace ID for logging

tasks:
  - id: execute
    type: io.kestra.plugin.scripts.shell.Commands
    description: Run generated tool via run-tool.nu
    taskRunner:
      type: io.kestra.plugin.core.runner.Process
    commands:
      - |
        # Write input JSON to temp file to avoid quoting issues
        cat > /tmp/exec-input.json << 'INPUTEOF'
        {{ inputs.tool_input }}
        INPUTEOF
        nu -c '
        let tool_input = (open /tmp/exec-input.json)
        let run_input = {
          tool_path: "{{ inputs.tool_path }}"
          tool_input: $tool_input
          output_path: "{{ inputs.output_path }}"
          logs_path: "{{ inputs.logs_path }}"
          context: { trace_id: "{{ inputs.trace_id }}" }
        }
        $run_input | to json | nu {{ inputs.tools_dir }}/run-tool.nu
        '

outputs:
  - id: output_file
    type: STRING
    value: "{{ inputs.output_path }}"

  - id: logs_file
    type: STRING
    value: "{{ inputs.logs_path }}"
