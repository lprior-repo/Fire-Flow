# Modular Component: Validate Tool Output Against Contract
#
# INPUT: contract_path, output_file (implicit /tmp/output.json)
# OUTPUT: validation_result (PASS/FAIL as JSON), errors (list)
# ERRORS: Graceful (exit 0, JSON response with valid: false)
#
# Pure function: contract + output -> validation result
# DataContract is the source of truth (Law 2: draconian validation)

id: validate-tool
namespace: bitter
description: Validate tool output against DataContract

inputs:
  - id: contract_path
    type: STRING
    description: Path to DataContract YAML file

  - id: output_path
    type: STRING
    defaults: "/tmp/output.json"
    description: Path to tool output file to validate

  - id: tools_dir
    type: STRING
    defaults: "./bitter-truth/tools"
    description: Directory containing bitter-truth tools

  - id: trace_id
    type: STRING
    defaults: ""
    description: Trace ID for logging

  - id: dry_run
    type: BOOLEAN
    defaults: false
    description: Skip validation, just return success

tasks:
  - id: validate
    type: io.kestra.plugin.scripts.shell.Commands
    description: Validate via DataContract + validate.nu
    taskRunner:
      type: io.kestra.plugin.core.runner.Process
    env:
      PATH: "/home/lewis/.local/bin:/usr/local/bin:/usr/bin:/bin"
      HOME: /tmp
      SODA_SEND_ANONYMOUS_USAGE_STATS: "false"
      KESTRA_EXECUTION_ID: "{{ execution.id }}"
    commands:
      - |
        nu -c '
        let validate_input = {
          contract_path: "{{ inputs.contract_path }}"
          output_path: "{{ inputs.output_path }}"
          server: "local"
          context: {
            trace_id: "{{ inputs.trace_id }}"
            dry_run: {{ inputs.dry_run }}
          }
        }
        $validate_input | to json | nu {{ inputs.tools_dir }}/validate.nu
        '

outputs:
  - id: validation_result
    type: STRING
    value: "{{ taskrun.stdout }}"

  - id: output_file
    type: STRING
    value: "{{ inputs.output_path }}"
