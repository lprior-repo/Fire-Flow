id: tcr-enforcement-workflow
namespace: fire.flow

description: |
  Kestra workflow that orchestrates the TCR (Test-Driven Code Review) enforcement process.
  This workflow integrates with the TCR enforcer CLI to enforce TDD principles.

inputs:
  - id: file_path
    type: STRING
    description: Path to the file being changed

tasks:
  - id: status
    type: io.kestra.core.tasks.log.Log
    message: "Checking current TCR state for file: {{ inputs.file_path }}"

  - id: tdd-gate
    type: io.kestra.plugin.scripts.shell.Commands
    description: Run TDD gate check
    taskRunner:
      type: io.kestra.plugin.core.runner.Process
    commands:
      - cd /home/lewis/src/Fire-Flow && ./bin/fire-flow tdd-gate --file {{ inputs.file_path }}

  - id: run-tests
    type: io.kestra.plugin.scripts.shell.Commands
    description: Run tests if TDD gate allows
    taskRunner:
      type: io.kestra.plugin.core.runner.Process
    commands:
      - cd /home/lewis/src/Fire-Flow && ./bin/fire-flow run-tests

  - id: commit
    type: io.kestra.plugin.scripts.shell.Commands
    description: Commit if tests pass
    taskRunner:
      type: io.kestra.plugin.core.runner.Process
    commands:
      - cd /home/lewis/src/Fire-Flow && ./bin/fire-flow commit --message "TCR: Auto-commit from workflow"

  - id: revert
    type: io.kestra.plugin.scripts.shell.Commands
    description: Revert if tests fail
    taskRunner:
      type: io.kestra.plugin.core.runner.Process
    commands:
      - cd /home/lewis/src/Fire-Flow && ./bin/fire-flow revert

  - id: complete
    type: io.kestra.core.tasks.log.Log
    message: "TCR workflow completed for file: {{ inputs.file_path }}"