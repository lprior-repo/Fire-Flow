id: opencode-beads-loop
namespace: fire.flow

description: |
  Runs OpenCode with Qwen3-Coder in a loop, working through beads until all are complete.
  Uses local Qwen3-Coder-30B model via llama-server on port 8080.

  Heavy Orchestrator Pattern:
  - Kestra handles flow control, retries, timeouts
  - OpenCode handles AI coding tasks
  - Beads provide work items

inputs:
  - id: working_dir
    type: STRING
    description: Working directory for the project
    defaults: /home/lewis/kestra/data/Fire-Flow

  - id: max_iterations
    type: INT
    description: Maximum iterations to prevent infinite loops
    defaults: 50

tasks:
  - id: start
    type: io.kestra.core.tasks.log.Log
    message: "Starting OpenCode+Qwen3 beads loop in {{ inputs.working_dir }}"

  - id: sync_repo_and_beads
    type: io.kestra.plugin.scripts.shell.Commands
    description: Pull latest code and sync beads database
    taskRunner:
      type: io.kestra.plugin.core.runner.Process
    commands:
      - |
        cd {{ inputs.working_dir }}
        export HOME="/home/lewis"
        export PATH="/home/lewis/.local/share/mise/installs/go/1.25.5/bin:/home/lewis/.local/bin:/usr/bin:$PATH"
        export GOROOT="/home/lewis/.local/share/mise/installs/go/1.25.5"

        # Git sync
        git stash 2>/dev/null || true
        git pull origin main 2>&1 || true
        git stash pop 2>/dev/null || true

        # Use fire-flow CLI for beads sync
        fire-flow sync-beads /home/lewis/src/Fire-Flow {{ inputs.working_dir }}

  - id: beads_loop
    type: io.kestra.plugin.core.flow.ForEach
    values: "{{ range(1, inputs.max_iterations) }}"
    tasks:
      - id: get_next_bead
        type: io.kestra.plugin.scripts.shell.Commands
        description: Get the next ready bead ID
        taskRunner:
          type: io.kestra.plugin.core.runner.Process
        commands:
          - |
            cd {{ inputs.working_dir }}
            export HOME="/home/lewis"
            export PATH="/home/lewis/.local/share/mise/installs/go/1.25.5/bin:/home/lewis/.local/bin:/usr/bin:$PATH"
            export GOROOT="/home/lewis/.local/share/mise/installs/go/1.25.5"

            # Use fire-flow CLI to get next bead
            fire-flow next-bead {{ inputs.working_dir }}

      - id: run_opencode
        type: io.kestra.plugin.scripts.shell.Commands
        description: Run OpenCode with Qwen3 to work on the bead
        taskRunner:
          type: io.kestra.plugin.core.runner.Process
        timeout: PT60M
        commands:
          - |
            cd {{ inputs.working_dir }}
            export HOME="/home/lewis"
            export PATH="/home/lewis/.local/share/mise/installs/go/1.25.5/bin:/home/lewis/.local/bin:/usr/bin:$PATH"
            export GOROOT="/home/lewis/.local/share/mise/installs/go/1.25.5"

            # Get next bead ID using fire-flow CLI
            BEAD_JSON=$(fire-flow next-bead {{ inputs.working_dir }} 2>/dev/null | tail -1)
            BEAD_ID=$(echo "$BEAD_JSON" | /usr/bin/grep -oP '"bead_id":\s*"\K[^"]+')

            if [ -z "$BEAD_ID" ]; then
              echo "No beads found, skipping"
              exit 0
            fi

            echo "Working on bead: $BEAD_ID"

            # Run AI on the bead using fire-flow CLI
            fire-flow run-ai "$BEAD_ID" local/qwen3-coder

      - id: iteration_log
        type: io.kestra.core.tasks.log.Log
        message: "Completed iteration {{ taskrun.value }}"

  - id: sync_final
    type: io.kestra.plugin.scripts.shell.Commands
    description: Push changes back to source and sync beads
    taskRunner:
      type: io.kestra.plugin.core.runner.Process
    commands:
      - |
        cd {{ inputs.working_dir }}
        export HOME="/home/lewis"
        export PATH="/home/lewis/.local/share/mise/installs/go/1.25.5/bin:/home/lewis/.local/bin:/usr/bin:$PATH"
        export GOROOT="/home/lewis/.local/share/mise/installs/go/1.25.5"

        # Use fire-flow CLI to push changes
        fire-flow push-changes "OpenCode+Qwen3: Auto-commit from Kestra workflow"

  - id: complete
    type: io.kestra.core.tasks.log.Log
    message: "OpenCode beads loop workflow completed"
