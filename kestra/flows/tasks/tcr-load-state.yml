id: tcr-load-state
namespace: fire.flow.tasks

description: |
  Atomic task: Load TCR state from state.json
  Returns structured state for workflow decisions.

  Pattern: Stateless task, single responsibility
  Based on AWS Step Functions best practice - tasks return data, orchestrator decides.

inputs:
  - id: working_dir
    type: STRING
    defaults: /home/lewis/src/Fire-Flow


tasks:
  - id: load
    type: io.kestra.plugin.scripts.shell.Commands
    taskRunner:
      type: io.kestra.plugin.core.runner.Process
    outputFiles:
      - state.json
    commands:
      - |
        STATE_FILE="{{ inputs.working_dir }}/.opencode/tcr/state.json"
        if [ -f "$STATE_FILE" ]; then
          cat "$STATE_FILE" > state.json
        else
          echo '{"version":"2.0","lastTestResult":false,"overlayActive":false}' > state.json
        fi
        cat state.json
